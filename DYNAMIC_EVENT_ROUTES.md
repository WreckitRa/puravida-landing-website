# Dynamic Event Routes with Static Export

This document explains how dynamic event routes (`/event/[id]`) work with Next.js static export.

## Problem

Next.js static export (`output: "export"`) requires all dynamic routes to be pre-generated via `generateStaticParams()`. This means we can't generate pages for every possible event ID at build time.

## Solution

We use a **fallback page** approach combined with Apache rewrite rules:

1. **Pre-generate a fallback page** at `/event/fallback.html`
2. **Apache rewrites** all `/event/[any-id]` requests to `/event/fallback.html`
3. **Client-side code** extracts the actual event ID from the URL and fetches data from the API

## Implementation

### 1. Generate Static Params

`app/event/[id]/page.tsx` includes `"fallback"` in `generateStaticParams()`:

```typescript
export async function generateStaticParams() {
  return [
    { id: "summer-vibes-2024" },
    { id: "rooftop-sessions" },
    { id: "pool-party" },
    { id: "fallback" }, // Fallback page for any event ID
  ];
}
```

This generates `/event/fallback.html` during build.

### 2. Apache Rewrite Rules

`public/.htaccess` includes a rewrite rule that routes all event IDs to the fallback:

```apache
# Route all /event/* to fallback.html
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^event/([^/]+)/?$ /event/fallback.html [L]
```

**Important**: This rule must come BEFORE the "Serve file if exists" rule.

### 3. Client-Side Event ID Extraction

`app/event/[id]/EventPageClient.tsx` extracts the event ID from the URL:

```typescript
useEffect(() => {
  // Extract event ID from URL path
  const pathParts = window.location.pathname.split("/").filter(Boolean);
  const eventIndex = pathParts.indexOf("event");
  const urlEventId = eventIndex >= 0 && pathParts[eventIndex + 1] 
    ? pathParts[eventIndex + 1] 
    : null;
  
  // Use URL event ID (not "fallback")
  const finalEventId = urlEventId && urlEventId !== "fallback" 
    ? urlEventId 
    : eventId;
  
  // Fetch event data using finalEventId
  fetchEventData(finalEventId);
}, [eventId]);
```

### 4. Post-Build Script

`scripts/post-build.js` ensures:
- `out/event/fallback.html` exists
- `.htaccess` is copied to `out/` directory
- Build validation

### 5. Build Process

The build process:
1. Next.js generates static pages (including `/event/fallback.html`)
2. Post-build script verifies fallback.html exists
3. `.htaccess` is automatically copied from `public/` to `out/`

## How It Works

### User Flow

1. User visits `/event/abc123`
2. Apache internally rewrites to `/event/fallback.html` (browser URL stays `/event/abc123`)
3. Browser loads `fallback.html` which contains the React app
4. React app reads `window.location.pathname` = `/event/abc123`
5. Extracts `abc123` as the event ID
6. Fetches event data from API: `GET /api/public/events/abc123`
7. Renders the event page with fetched data

### Build Output

After `npm run build`:
```
out/
  event/
    fallback.html      ← Generated by Next.js
    fallback/          ← Next.js internal files
    summer-vibes-2024.html
    pool-party.html
    ...
  .htaccess           ← Copied from public/
```

## Testing

### Dev Mode
- Dynamic routes work normally (no static export)
- Any `/event/[id]` works directly

### Production Build
```bash
npm run build
```

This will:
1. Build with static export
2. Generate `/event/fallback.html`
3. Run post-build script to verify everything

### Verify Fallback Exists
```bash
ls -la out/event/fallback.html
```

### Test Locally
```bash
# Serve the out directory
npx serve out

# Visit http://localhost:3000/event/any-id-here
# Should load the fallback page and fetch data
```

## Deployment

The `deploy.sh` script:
1. Builds the project
2. Uploads `out/` directory to server
3. Uploads `.htaccess` with event route rules

## Important Notes

- ✅ `/abla-bakh` page remains a static page (not affected)
- ✅ All other static pages work normally
- ✅ Dynamic event routes work via fallback + client-side fetching
- ✅ No server-side rendering required
- ✅ Works with any static hosting (Apache, Nginx, etc.)

## Troubleshooting

### Fallback.html not found
- Check `generateStaticParams()` includes `{ id: "fallback" }`
- Run post-build script manually: `node scripts/post-build.js`

### Event ID not extracted
- Check browser console for errors
- Verify `window.location.pathname` contains the event ID
- Check Apache rewrite rule is working (should preserve URL)

### 404 errors
- Verify `.htaccess` is in `out/` directory
- Check Apache `mod_rewrite` is enabled
- Verify rewrite rule comes before "Serve file if exists"


